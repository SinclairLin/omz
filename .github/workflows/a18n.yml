name: i18n-readme
on:
  workflow_dispatch:
  push:
    branches:
      - main
permissions:
  contents: write
jobs:
  translate-readme:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-openai
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install --upgrade openai

      - name: Translate README.md to English
        env:
          CHATGPT_API_KEY: ${{ secrets.CHATGPT_API_KEY }}
          CHATGPT_API_BASE: ${{ secrets.CHATGPT_API_BASE }}
          I18N_TARGET_LANG: en
          TRANSLATE_TARGET_LANG: en
          I18N_MODEL: ${{ vars.I18N_MODEL }}
        run: |
          python - <<'PY'
          import os
          from openai import OpenAI

          api_key = os.environ.get("CHATGPT_API_KEY")
          base_url = os.environ.get("CHATGPT_API_BASE")
          model = os.environ.get("I18N_MODEL") or "gemini-3-pro"

          if not api_key:
              raise SystemExit("CHATGPT_API_KEY is required")

          client = OpenAI(api_key=api_key, base_url=base_url or None)

          with open("README.md", "r", encoding="utf-8") as f:
              source = f.read()

          prompt = (
              "Translate the following Markdown from Chinese to English. "
              "Keep Markdown structure, headings, code blocks, commands, links, and file paths unchanged. "
              "Translate natural language only. Return Markdown only.\n\n"
              + source
          )

          resp = client.chat.completions.create(
              model=model,
              temperature=0.2,
              messages=[
                  {"role": "system", "content": "You are a professional technical translator."},
                  {"role": "user", "content": prompt},
              ],
          )

          text = (resp.choices[0].message.content or "").strip() + "\n"
          with open("README_EN.md", "w", encoding="utf-8") as f:
              f.write(text)
          PY

      - name: Commit and push translated README
        run: |
          if git diff --quiet -- README.md; then
            echo "README.md is up to date, nothing to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore(i18n): auto-translate README to English [skip ci]"
          git push origin HEAD:main
      - name: Install MkDocs dependencies
        run: pip install -r requirements.txt
      - name: Deploy with MkDocs
        run: mkdocs gh-deploy --force
